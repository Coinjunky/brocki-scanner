<script>
const API_URL = 'https://brocki-scanner.onrender.com';

const cameraInput = document.getElementById('cameraInput');
const previewImg = document.getElementById('previewImg');
const preview = document.getElementById('preview');
const results = document.getElementById('results');
const loading = document.getElementById('loading');
const error = document.getElementById('error');

let currentImage = null;

cameraInput.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = (event) => {
        currentImage = event.target.result;
        previewImg.src = currentImage;
        preview.style.display = 'block';
        analyzeImage(currentImage);
    };
    reader.readAsDataURL(file);
});

async function analyzeImage(imageData) {
    try {
        showLoading('Analyzing product...');
        hideError();
        results.style.display = 'none';

        // POST an das Backend (korrekte Route!)
        const response = await fetch(`${API_URL}/api/search`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                query: imageData // hier nur Platzhalter; f√ºr Textsuche backend-kompatibel
            })
        });

        if (!response.ok) throw new Error(`Server returned ${response.status}`);

        const data = await response.json();

        if (data.error) {
            showError(data.error);
        } else {
            displayResults(data, imageData);
        }

        hideLoading();
    } catch (err) {
        console.error('Analysis error:', err);
        showError('Connection failed. Make sure the backend is running.');
        hideLoading();
    }
}

function displayResults(data, query) {
    results.innerHTML = `<pre>${JSON.stringify(data, null, 2)}</pre>`;
    results.style.display = 'block';
}

// Hilfsfunktionen
function showLoading(msg) {
    loading.style.display = 'block';
    loading.querySelector('p').textContent = msg;
}
function hideLoading() { loading.style.display = 'none'; }
function showError(msg) { error.style.display = 'block'; error.textContent = msg; }
function hideError() { error.style.display = 'none'; }
</script>
